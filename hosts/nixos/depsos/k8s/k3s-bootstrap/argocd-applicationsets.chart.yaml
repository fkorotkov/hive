apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: argocd-applicationsets
  namespace: kube-system
spec:
  repo: https://bedag.github.io/helm-charts/
  chart: raw
  version: "1.1.0"
  helmVersion: v3
  bootstrap: true
  targetNamespace: argocd
  valuesContent: |-
    resources:
    - apiVersion: argoproj.io/v1alpha1
      kind: ApplicationSet
      metadata:
        name: cluster-addons
      spec:
        generators:
        - git:
            repoURL: https://github.com/truelecter/k8s-infra.git
            revision: master
            directories:
            - path: cluster-addons/*
        template:
          metadata:
            name: '{{ path.basename }}'
          spec:
            project: cluster-addons
            source:
              repoURL: https://github.com/truelecter/k8s-infra.git
              targetRevision: master
              path: '{{ path }}'
            destination:
              server: https://kubernetes.default.svc
              namespace: '{{ path.basename }}'
    - apiVersion: argoproj.io/v1alpha1
      kind: ApplicationSet
      metadata:
        name: services
      spec:
        generators:
        - git:
            repoURL: https://github.com/truelecter/k8s-infra.git
            revision: master
            directories:
            - path: services/*
        template:
          metadata:
            name: '{{ path[1] }}-{{ path.basename }}'
            labels:
              name: '{{ path.basename }}'
              env: '{{ path[1] }}'
          spec:
            project: '{{ path[1] }}'
            source:
              repoURL: https://github.com/truelecter/k8s-infra.git
              targetRevision: master
              path: '{{ path }}'
            destination:
              server: https://kubernetes.default.svc
              namespace: '{{ path.basename }}'
