name: "Build aarch64 configuration"
on:
  pull_request:
  push:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install Nix
      uses: cachix/install-nix-action@v17
      with:
        install_url: "https://releases.nixos.org/nix/nix-2.9.2/install"
    
    - name: Init cachix
      uses: cachix/cachix-action@v10
      with:
        name: truelecter
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    
    - name: Build
      uses: uraimo/run-on-arch-action@v2
      with:
        arch: aarch64
        distro: alpine_latest
        githubToken: ${{ github.token }}
        dockerRunArgs: --volume /nix:/nix
        install: apk --no-cache add curl git xz
        env: |
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          _system: aarch64-linux
        run: |
          set -euo pipefail
          mkdir -p /etc/nix

          echo "max-jobs = auto" >> /etc/nix/nix.conf
          echo "trusted-users = root" >> /etc/nix/nix.conf
          echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
          echo "build-users-group =" >> /etc/nix/nix.conf

          export USER=root

          echo "::group::Install nix"

          sh <(curl -L https://releases.nixos.org/nix/nix-2.9.2/install) --no-channel-add
          . ${HOME}/.nix-profile/etc/profile.d/nix.sh

          echo "::group::Setup cachix"

          nix-env --quiet -j8 -iA cachix -f https://cachix.org/api/v1/install
          cachix use nix-community
          cachix use mic92,nrdxp
          cachix use nrdxp

          echo "::group::Build"

          git config --global --add safe.directory "$(pwd)"

          nix build '.#nixosConfigurations.octoprint.config.system.build.toplevel' | cachix push mycache